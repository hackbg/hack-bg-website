<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="lang">
  <head>
    <title data-vue-tag="true">Building Voting æpp with Sophia ML on æternity blockchain - hack</title><meta data-vue-tag="true" charset="utf-8"><meta data-vue-tag="true" name="generator" content="Gridsome v0.6.9"><meta data-vue-tag="true" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="true" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="true" data-key="description" name="description" content="Blockchain &amp; DLT Solutions"><link data-vue-tag="true" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.9d75ece.png"><link data-vue-tag="true" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.9d75ece.png"><link data-vue-tag="true" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.9d75ece.png"><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.9d75ece.png"><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.9d75ece.png"><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.9d75ece.png"><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.9d75ece.png"><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.9d75ece.png"><link data-vue-tag="true" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli:400,400i,700%7CRoboto:700&amp;display=swap"><noscript data-vue-tag="true" ><style>.g-image--loading{display:none;}</style></noscript><link rel="preload" href="/assets/css/1.styles.62bc704f.css" as="style"><link rel="preload" href="/assets/js/app.65886749.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--word-press-post-vue.6b96b889.js" as="script"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.c0056c42.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.cc0ddc96.js"><link rel="prefetch" href="/assets/js/page--src--pages--blog-vue.31e5c933.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.209c66e6.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-author-vue.f3682281.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-category-vue.6c1d1f0a.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-tag-vue.ca30f2b9.js"><link rel="prefetch" href="/assets/js/page--src--templates--wordpress-page-vue.f6d3f943.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--blog-vue~page--src--templates--word-press-author-vue~page--src--templates-~38dfac69.e03723d9.js"><link rel="stylesheet" href="/assets/css/1.styles.62bc704f.css">
  </head>
  <body data-vue-tag="">
    <div id="app" data-server-rendered="true"><div class="container"><header class="py-4 py-sm-5"><nav class="navbar p-0 navbar-light navbar-expand-lg"><div class="navbar-brand"><a href="/" target="_self" class="navbar-brand font-family-headings router-link-active"><span class="h3 text-dark">hack</span></a></div><button type="button" aria-label="Toggle navigation" aria-controls="nav-collapse" aria-expanded="false" class="navbar-toggler"><span class="navbar-toggler-icon"></span></button><div id="nav-collapse" class="navbar-collapse collapse" style="display:none;"><ul class="navbar-nav ml-auto"><li class="nav-item"><a href="/" target="_self" class="nav-link router-link-active">Home</a></li><li class="nav-item"><a href="/about" target="_self" class="nav-link">About</a></li><li class="nav-item"><a href="/blog" target="_self" class="nav-link active">Blog</a></li></ul></div></nav></header><!----><main><div class="row align-items-start"><main class="bg-white p-0 rounded shadow-lg col-lg-12 col-12"><div class="overflow-hidden p-4 p-sm-5 "><article class="row"><div data-first="B" class="meta-data py-md-5 text-center position-relative d-flex col-md-3"><div class="mx-auto mb-2 position-relative"><span class="post-date font-weight-bold">23 Jan 2019</span><i class="d-none d-md-block">in:</i><ul class="list-inline mb-0"><li class="list-inline-item m-0"><a href="/category/tutorials" class="text-uppercase font-weight-bold mx-1">Tutorials</a><span>·</span></li><li class="list-inline-item m-0"><a href="/category/blockchain-tech-talks" class="text-uppercase font-weight-bold mx-1">Tech Talks</a><!----></li></ul><div><i>by: </i><a href="/author/milen" class="font-weight-bold">
          Milen Radkov
        </a></div></div></div><div class="mb-5 py-md-5 col"><header class="mb-4"><h1 class="text-break">Building Voting æpp with Sophia ML on æternity blockchain</h1><img src="https://hack.bg/wp-content/uploads/2019/01/aepps-summit.jpg" width="960" class="mt-4 img-fluid"></header><div class="post-content text-break">
<p>Time is passing by and we are getting more experienced in writing smart contracts with Sophia ML language on æ<g class="gr_ gr_8 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="8" data-gr-id="8">ternity</g> blockchain.</p>



<p>In this tutorial, I&#8217;d like to share with you a simple voting decentralized <g class="gr_ gr_3 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="3" data-gr-id="3">aepp</g> solution that we&#8217;ve built during the æpps summit in Turkey, which I took part in.</p>



<div class="wp-block-image"><figure class="aligncenter"><img src="https://hack.bg/wp-content/uploads/2019/01/aepps-summit.jpg" alt="" class="wp-image-542" srcset="https://hack.bg/wp-content/uploads/2019/01/aepps-summit.jpg 960w, https://hack.bg/wp-content/uploads/2019/01/aepps-summit-300x169.jpg 300w, https://hack.bg/wp-content/uploads/2019/01/aepps-summit-768x432.jpg 768w" sizes="(max-width: 960px) 100vw, 960px" /><figcaption>photo by nikita fuchs</figcaption></figure></div>



<p>This was one of my first times interacting with Sophia ML smart contracts, and while at the æpps summit I&#8217;ve gathered some cool and enthusiastic people, and made ourselves sort of a studying group. We decided to brainstorm and learn together while developing this voting <g class="gr_ gr_6 gr-alert gr_spell gr_inline_cards gr_disable_anim_appear ContextualSpelling ins-del multiReplace" id="6" data-gr-id="6">aepp</g>. This is the short summary of what we&#8217;ve decided our voting <g class="gr_ gr_7 gr-alert gr_spell gr_inline_cards gr_disable_anim_appear ContextualSpelling ins-del multiReplace" id="7" data-gr-id="7">aepp</g> will be doing:</p>



<ol><li>Add candidates to vote for</li><li>Allow users to give their vote for a certain candidate</li><li>Count the votes that every candidate gathered</li></ol>



<p class="note">You can <g class="gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar only-ins replaceWithoutSep" id="5" data-gr-id="5">try</g> push the <g class="gr_ gr_3 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="3" data-gr-id="3">aepp&#8217;s</g> functionalities further, with more sophisticated functions and use case, you can try doing it <g class="gr_ gr_7 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-del replaceWithoutSep" id="7" data-gr-id="7">yourself,</g> <g class="gr_ gr_25 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" id="25" data-gr-id="25">like</g> we did. Try it &#8211; its fun.</p>



<h2>Setting up project and development <g class="gr_ gr_109 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace gr-progress" id="109" data-gr-id="109">environment</g></h2>



<p><g class="gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep" id="5" data-gr-id="5">First</g> we have to initialize our project where we will write <g class="gr_ gr_4 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" id="4" data-gr-id="4">the smart</g> contract. In order to do that we will be using <code>forgae</code>. Take a look at the <a href="https://hack.bg/blog/tutorials/build-your-first-decentralized-application-aepp-on-aeternity-blockchain-sophia-smart-contract-address-book/">Build first </a><g class="gr_ gr_92 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="92" data-gr-id="92"><a href="https://hack.bg/blog/tutorials/build-your-first-decentralized-application-aepp-on-aeternity-blockchain-sophia-smart-contract-address-book/">aeternity</a></g><a href="https://hack.bg/blog/tutorials/build-your-first-decentralized-application-aepp-on-aeternity-blockchain-sophia-smart-contract-address-book/"> application with Sophia ML tutorial</a> and follow the steps to initialize your project.</p>



<h2>Smart contract</h2>



<p>As you probably already know (if you&#8217;ve followed the previous tutorial), in <g class="gr_ gr_3 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep" id="3" data-gr-id="3">Sophia</g> ML we have a <strong>state</strong> which is the place where we store data on-chain, and it is the only thing in the smart contract that can be mutated (overwritten).</p>



<p>The first thing we do is to define our variables and types that we are going to use in the smart contract. And <g class="gr_ gr_217 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="217" data-gr-id="217">the </g><code>init()</code><g class="gr_ gr_217 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="217" data-gr-id="217"> function</g> which is the constructor basically, if we compare this to a Solidity smart contract.</p>



<pre class="wp-block-preformatted"><code>contract Vote =
   type candidate = address
   type votes = list(address)

   record state = 
      { vote : map(candidate, votes) }

   public function init() : state = 
      { vote = { } }</code></pre>



<p>We are defining <g class="gr_ gr_263 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="263" data-gr-id="263">the </g><code>candidate</code><g class="gr_ gr_263 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="263" data-gr-id="263"> type</g> as address, and votes as a <strong>list</strong> of addresses. And the <code>state</code> record will be storing a map (key-value-pair) of <code>candidate</code> to <code>votes</code>.<br></p>



<p><del>Starting with the first functionality for the aepp &#8211; adding candidates:</del></p>



<pre class="wp-block-preformatted"><code><del>  public stateful function add_candidate(candidate: address) : bool =       is_candidate(candidate)       true</del></code></pre>



<p><del>What this does is passing the candidate to the </del><code><del>is_candiate()</del></code><del> function &#8211; taking a candidate&#8217;s address as a parameter, checking if there is a candidate defined at with this address and saving it to the </del><strong><del>votes</del></strong><del> mapping in the state with the initial empty list of voters if not.</del><br></p>



<p><del>Here are the helper functions we are using for this:</del></p>



<pre class="wp-block-preformatted"><code><del>   private stateful function is_candidate(candidate: address) =       let candidate_found = lookupByAddress(candidate, state.votes, { voters = [] })       if (size(candidate_found.voters) == 0)          put(state{             votes[candidate] = { voters = [] } })    private function lookupByAddress(k : address, m, v) =       switch(Map.lookup(k,m))          None => v          Some(x) => x</del></code></pre>



<p>We are doing this because in Sophia ML we don&#8217;t have a default value of 0x0/false as in Solidity for example. So, in order for us to cast a vote, we need to first have added the candidates which we can vote for.</p>



<p class="note">If we don&#8217;t add the candidate first, before voting, we will hit <code>out of gas</code> error.</p>



<p>Next we create the vote function which looks like this:</p>



<pre class="wp-block-preformatted"><code>public stateful function vote(vote_for: candidate) =
      put(state{ vote[vote_for = []] @ vs = Call.caller :: vs })</code></pre>



<p>We access the transaction initiator&#8217;s address by the <g class="gr_ gr_3 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="3" data-gr-id="3">built </g><g class="gr_ gr_4 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="4" data-gr-id="4"><g class="gr_ gr_3 gr-alert gr_spell gr_inline_cards gr_disable_anim_appear ContextualSpelling ins-del multiReplace" id="3" data-gr-id="3">in</g> </g><code>Call.caller</code><g class="gr_ gr_4 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="4" data-gr-id="4"> and</g> prepend <g class="gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="5" data-gr-id="5">it </g><code>::</code><g class="gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="5" data-gr-id="5"> to</g> the current list of voters. Using this <g class="gr_ gr_23 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="23" data-gr-id="23">syntx</g> we <g class="gr_ gr_32 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="32" data-gr-id="32">dont</g> need to worry whether the candidate was initialized or not.</p>



<p><g class="gr_ gr_9 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar only-ins replaceWithoutSep" id="9" data-gr-id="9">Last</g> thing is the get votes count function.</p>



<pre class="wp-block-preformatted"><code>public function count_votes(count_for : candidate) =
      length(state.vote[count_for = []])</code></pre>



<p>Here we are using a custom <code>length</code> function which we define as a helper function below. Here is the code and below we can see the explanation.</p>



<pre class="wp-block-preformatted"><code>private function length(l : list('a)) : int = length'(l, 0)
</code></pre>



<p>This is where things get a bit more complicated, so I will try to explain what is happening here.</p>



<p>Since in Sophia ML we don&#8217;t have <code>.count</code> or <code>.length</code> to get the list length, we need to make ourselves a helper function which will make a recursion and will iterate over the list while incrementing a counter.</p>



<p>The <code>length</code> function is defined to accept a list <g class="gr_ gr_9 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="9" data-gr-id="9">of </g><code>'a</code><g class="gr_ gr_9 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="9" data-gr-id="9"> which</g> is the convention for a generic <g class="gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-del replaceWithoutSep" id="5" data-gr-id="5">type,</g> and a return <g class="gr_ gr_11 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="11" data-gr-id="11">type </g><code>int</code><g class="gr_ gr_11 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="11" data-gr-id="11"> .</g> In the function&#8217;s <g class="gr_ gr_6 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep" id="6" data-gr-id="6">body</g> we are calling <g class="gr_ gr_10 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="10" data-gr-id="10">the </g><code>length'</code><g class="gr_ gr_10 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="10" data-gr-id="10"> </g><g class="gr_ gr_7 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-del replaceWithoutSep" id="7" data-gr-id="7"><g class="gr_ gr_10 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="10" data-gr-id="10">function</g>,</g> while passing the list and an initial value for the counter.</p>



<pre class="wp-block-preformatted"><code>private function length'(l : list('a), x : int) : int =       switch(l)          [] => x          _ :: l' => length'(l', x + 1)</code></pre>



<p>And here the magic happens, we use <g class="gr_ gr_6 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="6" data-gr-id="6">the </g><code>switch</code><g class="gr_ gr_6 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" id="6" data-gr-id="6"> statement</g> with 2 cases <code>[] => x</code> &#8211; which returns the value of the counter and breaks the recursion if the list is empty. And <code>_ :: l' => length'(l', x+1)</code> &#8211; meaning we are using a pattern matching and we are separating the first element from the list and the remainder and then recursively passing the list&#8217;s remainder to the same <g class="gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-del replaceWithoutSep" id="5" data-gr-id="5">function,</g> while incrementing the counter.</p>



<p>The whole smart contract code looks like this in the end</p>



<figure><script src="https://gist.github.com/mradkov/d05aeb76c59e2098d54dc900e94aaa41.js"></script><figcaption>Sophia ML basic voting aepp</figcaption></figure>



<h2>Conclusion</h2>



<p>It is fairly simple to create a basic aepp on æternity blockchain using Sophia ML. In our case with the ae-vote we stumbled upon some tricky parts like the recursive iteration, we had to make above, but when you familiarize yourself with the language it is easier.</p>



<h3>Useful links</h3>



<ul><li><a href="https://github.com/mradkov/ae-vote">Github repo of the project</a></li><li><a href="https://github.com/aeternity/protocol/blob/master/contracts/sophia.md">Sophia documentation</a></li><li><a href="https://dev.aepps.com/">æternity documentation</a></li></ul>
</div><h2 class="font-family-sans-serif h4">Tags:</h2><ul class="list-inline"><li class="list-inline-item"><a href="/tag/aeternity" target="_self" class="btn mb-2 btn-primary btn-sm">
                    Aeternity (13)
                  </a></li><li class="list-inline-item"><a href="/tag/blockchain" target="_self" class="btn mb-2 btn-primary btn-sm">
                    Blockchain (42)
                  </a></li><li class="list-inline-item"><a href="/tag/smart-contracts" target="_self" class="btn mb-2 btn-primary btn-sm">
                    Smart Contracts (17)
                  </a></li><li class="list-inline-item"><a href="/tag/sophia-ml" target="_self" class="btn mb-2 btn-primary btn-sm">
                    Sophia ML (3)
                  </a></li><li class="list-inline-item"><a href="/tag/tutorial" target="_self" class="btn mb-2 btn-primary btn-sm">
                    Tutorial (2)
                  </a></li></ul></div></article></div></main></div></main><!----></div><footer class="bg-white text-center py-5 mt-5">
  Open source - <a href="https://hack.bg/">hack</a></footer></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"title":"Building Voting æpp with Sophia ML on æternity blockchain","date":"2019-01-23T20:11:11","content":"\n\u003Cp\u003ETime is passing by and we are getting more experienced in writing smart contracts with Sophia ML language on æ\u003Cg class=\"gr_ gr_8 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace\" id=\"8\" data-gr-id=\"8\"\u003Eternity\u003C\u002Fg\u003E blockchain.\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003EIn this tutorial, I&#8217;d like to share with you a simple voting decentralized \u003Cg class=\"gr_ gr_3 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace\" id=\"3\" data-gr-id=\"3\"\u003Eaepp\u003C\u002Fg\u003E solution that we&#8217;ve built during the æpps summit in Turkey, which I took part in.\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter\"\u003E\u003Cimg src=\"https:\u002F\u002Fhack.bg\u002Fwp-content\u002Fuploads\u002F2019\u002F01\u002Faepps-summit.jpg\" alt=\"\" class=\"wp-image-542\" srcset=\"https:\u002F\u002Fhack.bg\u002Fwp-content\u002Fuploads\u002F2019\u002F01\u002Faepps-summit.jpg 960w, https:\u002F\u002Fhack.bg\u002Fwp-content\u002Fuploads\u002F2019\u002F01\u002Faepps-summit-300x169.jpg 300w, https:\u002F\u002Fhack.bg\u002Fwp-content\u002Fuploads\u002F2019\u002F01\u002Faepps-summit-768x432.jpg 768w\" sizes=\"(max-width: 960px) 100vw, 960px\" \u002F\u003E\u003Cfigcaption\u003Ephoto by nikita fuchs\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EThis was one of my first times interacting with Sophia ML smart contracts, and while at the æpps summit I&#8217;ve gathered some cool and enthusiastic people, and made ourselves sort of a studying group. We decided to brainstorm and learn together while developing this voting \u003Cg class=\"gr_ gr_6 gr-alert gr_spell gr_inline_cards gr_disable_anim_appear ContextualSpelling ins-del multiReplace\" id=\"6\" data-gr-id=\"6\"\u003Eaepp\u003C\u002Fg\u003E. This is the short summary of what we&#8217;ve decided our voting \u003Cg class=\"gr_ gr_7 gr-alert gr_spell gr_inline_cards gr_disable_anim_appear ContextualSpelling ins-del multiReplace\" id=\"7\" data-gr-id=\"7\"\u003Eaepp\u003C\u002Fg\u003E will be doing:\u003C\u002Fp\u003E\n\n\n\n\u003Col\u003E\u003Cli\u003EAdd candidates to vote for\u003C\u002Fli\u003E\u003Cli\u003EAllow users to give their vote for a certain candidate\u003C\u002Fli\u003E\u003Cli\u003ECount the votes that every candidate gathered\u003C\u002Fli\u003E\u003C\u002Fol\u003E\n\n\n\n\u003Cp class=\"note\"\u003EYou can \u003Cg class=\"gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar only-ins replaceWithoutSep\" id=\"5\" data-gr-id=\"5\"\u003Etry\u003C\u002Fg\u003E push the \u003Cg class=\"gr_ gr_3 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace\" id=\"3\" data-gr-id=\"3\"\u003Eaepp&#8217;s\u003C\u002Fg\u003E functionalities further, with more sophisticated functions and use case, you can try doing it \u003Cg class=\"gr_ gr_7 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-del replaceWithoutSep\" id=\"7\" data-gr-id=\"7\"\u003Eyourself,\u003C\u002Fg\u003E \u003Cg class=\"gr_ gr_25 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace\" id=\"25\" data-gr-id=\"25\"\u003Elike\u003C\u002Fg\u003E we did. Try it &#8211; its fun.\u003C\u002Fp\u003E\n\n\n\n\u003Ch2\u003ESetting up project and development \u003Cg class=\"gr_ gr_109 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace gr-progress\" id=\"109\" data-gr-id=\"109\"\u003Eenvironment\u003C\u002Fg\u003E\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003E\u003Cg class=\"gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep\" id=\"5\" data-gr-id=\"5\"\u003EFirst\u003C\u002Fg\u003E we have to initialize our project where we will write \u003Cg class=\"gr_ gr_4 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace\" id=\"4\" data-gr-id=\"4\"\u003Ethe smart\u003C\u002Fg\u003E contract. In order to do that we will be using \u003Ccode\u003Eforgae\u003C\u002Fcode\u003E. Take a look at the \u003Ca href=\"https:\u002F\u002Fhack.bg\u002Fblog\u002Ftutorials\u002Fbuild-your-first-decentralized-application-aepp-on-aeternity-blockchain-sophia-smart-contract-address-book\u002F\"\u003EBuild first \u003C\u002Fa\u003E\u003Cg class=\"gr_ gr_92 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace\" id=\"92\" data-gr-id=\"92\"\u003E\u003Ca href=\"https:\u002F\u002Fhack.bg\u002Fblog\u002Ftutorials\u002Fbuild-your-first-decentralized-application-aepp-on-aeternity-blockchain-sophia-smart-contract-address-book\u002F\"\u003Eaeternity\u003C\u002Fa\u003E\u003C\u002Fg\u003E\u003Ca href=\"https:\u002F\u002Fhack.bg\u002Fblog\u002Ftutorials\u002Fbuild-your-first-decentralized-application-aepp-on-aeternity-blockchain-sophia-smart-contract-address-book\u002F\"\u003E application with Sophia ML tutorial\u003C\u002Fa\u003E and follow the steps to initialize your project.\u003C\u002Fp\u003E\n\n\n\n\u003Ch2\u003ESmart contract\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003EAs you probably already know (if you&#8217;ve followed the previous tutorial), in \u003Cg class=\"gr_ gr_3 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep\" id=\"3\" data-gr-id=\"3\"\u003ESophia\u003C\u002Fg\u003E ML we have a \u003Cstrong\u003Estate\u003C\u002Fstrong\u003E which is the place where we store data on-chain, and it is the only thing in the smart contract that can be mutated (overwritten).\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003EThe first thing we do is to define our variables and types that we are going to use in the smart contract. And \u003Cg class=\"gr_ gr_217 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace\" id=\"217\" data-gr-id=\"217\"\u003Ethe \u003C\u002Fg\u003E\u003Ccode\u003Einit()\u003C\u002Fcode\u003E\u003Cg class=\"gr_ gr_217 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"217\" data-gr-id=\"217\"\u003E function\u003C\u002Fg\u003E which is the constructor basically, if we compare this to a Solidity smart contract.\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-preformatted\"\u003E\u003Ccode\u003Econtract Vote =\n   type candidate = address\n   type votes = list(address)\n\n   record state = \n      { vote : map(candidate, votes) }\n\n   public function init() : state = \n      { vote = { } }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003EWe are defining \u003Cg class=\"gr_ gr_263 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace\" id=\"263\" data-gr-id=\"263\"\u003Ethe \u003C\u002Fg\u003E\u003Ccode\u003Ecandidate\u003C\u002Fcode\u003E\u003Cg class=\"gr_ gr_263 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"263\" data-gr-id=\"263\"\u003E type\u003C\u002Fg\u003E as address, and votes as a \u003Cstrong\u003Elist\u003C\u002Fstrong\u003E of addresses. And the \u003Ccode\u003Estate\u003C\u002Fcode\u003E record will be storing a map (key-value-pair) of \u003Ccode\u003Ecandidate\u003C\u002Fcode\u003E to \u003Ccode\u003Evotes\u003C\u002Fcode\u003E.\u003Cbr\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E\u003Cdel\u003EStarting with the first functionality for the aepp &#8211; adding candidates:\u003C\u002Fdel\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-preformatted\"\u003E\u003Ccode\u003E\u003Cdel\u003E  public stateful function add_candidate(candidate: address) : bool =       is_candidate(candidate)       true\u003C\u002Fdel\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003E\u003Cdel\u003EWhat this does is passing the candidate to the \u003C\u002Fdel\u003E\u003Ccode\u003E\u003Cdel\u003Eis_candiate()\u003C\u002Fdel\u003E\u003C\u002Fcode\u003E\u003Cdel\u003E function &#8211; taking a candidate&#8217;s address as a parameter, checking if there is a candidate defined at with this address and saving it to the \u003C\u002Fdel\u003E\u003Cstrong\u003E\u003Cdel\u003Evotes\u003C\u002Fdel\u003E\u003C\u002Fstrong\u003E\u003Cdel\u003E mapping in the state with the initial empty list of voters if not.\u003C\u002Fdel\u003E\u003Cbr\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E\u003Cdel\u003EHere are the helper functions we are using for this:\u003C\u002Fdel\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-preformatted\"\u003E\u003Ccode\u003E\u003Cdel\u003E   private stateful function is_candidate(candidate: address) =       let candidate_found = lookupByAddress(candidate, state.votes, { voters = [] })       if (size(candidate_found.voters) == 0)          put(state{             votes[candidate] = { voters = [] } })    private function lookupByAddress(k : address, m, v) =       switch(Map.lookup(k,m))          None =\u003E v          Some(x) =\u003E x\u003C\u002Fdel\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003EWe are doing this because in Sophia ML we don&#8217;t have a default value of 0x0\u002Ffalse as in Solidity for example. So, in order for us to cast a vote, we need to first have added the candidates which we can vote for.\u003C\u002Fp\u003E\n\n\n\n\u003Cp class=\"note\"\u003EIf we don&#8217;t add the candidate first, before voting, we will hit \u003Ccode\u003Eout of gas\u003C\u002Fcode\u003E error.\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003ENext we create the vote function which looks like this:\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-preformatted\"\u003E\u003Ccode\u003Epublic stateful function vote(vote_for: candidate) =\n      put(state{ vote[vote_for = []] @ vs = Call.caller :: vs })\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003EWe access the transaction initiator&#8217;s address by the \u003Cg class=\"gr_ gr_3 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace\" id=\"3\" data-gr-id=\"3\"\u003Ebuilt \u003C\u002Fg\u003E\u003Cg class=\"gr_ gr_4 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace\" id=\"4\" data-gr-id=\"4\"\u003E\u003Cg class=\"gr_ gr_3 gr-alert gr_spell gr_inline_cards gr_disable_anim_appear ContextualSpelling ins-del multiReplace\" id=\"3\" data-gr-id=\"3\"\u003Ein\u003C\u002Fg\u003E \u003C\u002Fg\u003E\u003Ccode\u003ECall.caller\u003C\u002Fcode\u003E\u003Cg class=\"gr_ gr_4 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"4\" data-gr-id=\"4\"\u003E and\u003C\u002Fg\u003E prepend \u003Cg class=\"gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace\" id=\"5\" data-gr-id=\"5\"\u003Eit \u003C\u002Fg\u003E\u003Ccode\u003E::\u003C\u002Fcode\u003E\u003Cg class=\"gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"5\" data-gr-id=\"5\"\u003E to\u003C\u002Fg\u003E the current list of voters. Using this \u003Cg class=\"gr_ gr_23 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace\" id=\"23\" data-gr-id=\"23\"\u003Esyntx\u003C\u002Fg\u003E we \u003Cg class=\"gr_ gr_32 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace\" id=\"32\" data-gr-id=\"32\"\u003Edont\u003C\u002Fg\u003E need to worry whether the candidate was initialized or not.\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E\u003Cg class=\"gr_ gr_9 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar only-ins replaceWithoutSep\" id=\"9\" data-gr-id=\"9\"\u003ELast\u003C\u002Fg\u003E thing is the get votes count function.\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-preformatted\"\u003E\u003Ccode\u003Epublic function count_votes(count_for : candidate) =\n      length(state.vote[count_for = []])\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003EHere we are using a custom \u003Ccode\u003Elength\u003C\u002Fcode\u003E function which we define as a helper function below. Here is the code and below we can see the explanation.\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-preformatted\"\u003E\u003Ccode\u003Eprivate function length(l : list('a)) : int = length'(l, 0)\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003EThis is where things get a bit more complicated, so I will try to explain what is happening here.\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003ESince in Sophia ML we don&#8217;t have \u003Ccode\u003E.count\u003C\u002Fcode\u003E or \u003Ccode\u003E.length\u003C\u002Fcode\u003E to get the list length, we need to make ourselves a helper function which will make a recursion and will iterate over the list while incrementing a counter.\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003EThe \u003Ccode\u003Elength\u003C\u002Fcode\u003E function is defined to accept a list \u003Cg class=\"gr_ gr_9 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace\" id=\"9\" data-gr-id=\"9\"\u003Eof \u003C\u002Fg\u003E\u003Ccode\u003E'a\u003C\u002Fcode\u003E\u003Cg class=\"gr_ gr_9 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"9\" data-gr-id=\"9\"\u003E which\u003C\u002Fg\u003E is the convention for a generic \u003Cg class=\"gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-del replaceWithoutSep\" id=\"5\" data-gr-id=\"5\"\u003Etype,\u003C\u002Fg\u003E and a return \u003Cg class=\"gr_ gr_11 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace\" id=\"11\" data-gr-id=\"11\"\u003Etype \u003C\u002Fg\u003E\u003Ccode\u003Eint\u003C\u002Fcode\u003E\u003Cg class=\"gr_ gr_11 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"11\" data-gr-id=\"11\"\u003E .\u003C\u002Fg\u003E In the function&#8217;s \u003Cg class=\"gr_ gr_6 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep\" id=\"6\" data-gr-id=\"6\"\u003Ebody\u003C\u002Fg\u003E we are calling \u003Cg class=\"gr_ gr_10 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace\" id=\"10\" data-gr-id=\"10\"\u003Ethe \u003C\u002Fg\u003E\u003Ccode\u003Elength'\u003C\u002Fcode\u003E\u003Cg class=\"gr_ gr_10 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"10\" data-gr-id=\"10\"\u003E \u003C\u002Fg\u003E\u003Cg class=\"gr_ gr_7 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-del replaceWithoutSep\" id=\"7\" data-gr-id=\"7\"\u003E\u003Cg class=\"gr_ gr_10 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"10\" data-gr-id=\"10\"\u003Efunction\u003C\u002Fg\u003E,\u003C\u002Fg\u003E while passing the list and an initial value for the counter.\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-preformatted\"\u003E\u003Ccode\u003Eprivate function length'(l : list('a), x : int) : int =       switch(l)          [] =\u003E x          _ :: l' =\u003E length'(l', x + 1)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003EAnd here the magic happens, we use \u003Cg class=\"gr_ gr_6 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace\" id=\"6\" data-gr-id=\"6\"\u003Ethe \u003C\u002Fg\u003E\u003Ccode\u003Eswitch\u003C\u002Fcode\u003E\u003Cg class=\"gr_ gr_6 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace\" id=\"6\" data-gr-id=\"6\"\u003E statement\u003C\u002Fg\u003E with 2 cases \u003Ccode\u003E[] =\u003E x\u003C\u002Fcode\u003E &#8211; which returns the value of the counter and breaks the recursion if the list is empty. And \u003Ccode\u003E_ :: l' =\u003E length'(l', x+1)\u003C\u002Fcode\u003E &#8211; meaning we are using a pattern matching and we are separating the first element from the list and the remainder and then recursively passing the list&#8217;s remainder to the same \u003Cg class=\"gr_ gr_5 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-del replaceWithoutSep\" id=\"5\" data-gr-id=\"5\"\u003Efunction,\u003C\u002Fg\u003E while incrementing the counter.\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003EThe whole smart contract code looks like this in the end\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure\u003E\u003Cscript src=\"https:\u002F\u002Fgist.github.com\u002Fmradkov\u002Fd05aeb76c59e2098d54dc900e94aaa41.js\"\u003E\u003C\u002Fscript\u003E\u003Cfigcaption\u003ESophia ML basic voting aepp\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Ch2\u003EConclusion\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003EIt is fairly simple to create a basic aepp on æternity blockchain using Sophia ML. In our case with the ae-vote we stumbled upon some tricky parts like the recursive iteration, we had to make above, but when you familiarize yourself with the language it is easier.\u003C\u002Fp\u003E\n\n\n\n\u003Ch3\u003EUseful links\u003C\u002Fh3\u003E\n\n\n\n\u003Cul\u003E\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fmradkov\u002Fae-vote\"\u003EGithub repo of the project\u003C\u002Fa\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faeternity\u002Fprotocol\u002Fblob\u002Fmaster\u002Fcontracts\u002Fsophia.md\"\u003ESophia documentation\u003C\u002Fa\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fdev.aepps.com\u002F\"\u003Eæternity documentation\u003C\u002Fa\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\n","featuredMedia":{"sourceUrl":"https:\u002F\u002Fhack.bg\u002Fwp-content\u002Fuploads\u002F2019\u002F01\u002Faepps-summit.jpg","altText":"","mediaDetails":{"width":960}},"categories":[{"id":"4","title":"Tutorials","path":"\u002Fcategory\u002Ftutorials"},{"id":"53","title":"Tech Talks","path":"\u002Fcategory\u002Fblockchain-tech-talks"}],"tags":[{"id":"22","title":"Aeternity","path":"\u002Ftag\u002Faeternity","count":13},{"id":"13","title":"Blockchain","path":"\u002Ftag\u002Fblockchain","count":42},{"id":"20","title":"Smart Contracts","path":"\u002Ftag\u002Fsmart-contracts","count":17},{"id":"74","title":"Sophia ML","path":"\u002Ftag\u002Fsophia-ml","count":3},{"id":"75","title":"Tutorial","path":"\u002Ftag\u002Ftutorial","count":2}],"author":{"name":"Milen Radkov","path":"\u002Fauthor\u002Fmilen"}}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.65886749.js" defer></script><script src="/assets/js/page--src--templates--word-press-post-vue.6b96b889.js" defer></script>
  </body>
</html>
